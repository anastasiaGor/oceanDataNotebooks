# Module containing some useful functions for parameters of the EOS following https://github.com/TEOS-10/
import xarray as xr
import numpy as np

gsw_sfac = 0.0248826675584615
offset = 5.971840214030754e-1

a000 = -1.56497346750e-5 
a001 =  1.85057654290e-5 
a002 = -1.17363867310e-6 
a003 = -3.65270065530e-7 
a004 =  3.14540999020e-7 
a010 =  5.55242129680e-5 
a011 = -2.34332137060e-5 
a012 =  4.26100574800e-6 
a013 =  5.73918103180e-7 
a020 = -4.95634777770e-5 
a021 =  2.37838968519e-5 
a022 = -1.38397620111e-6 
a030 =  2.76445290808e-5 
a031 = -1.36408749928e-5 
a032 = -2.53411666056e-7 
a040 = -4.02698077700e-6 
a041 =  2.53683834070e-6 
a050 =  1.23258565608e-6 
a100 =  3.50095997640e-5 
a101 = -9.56770881560e-6 
a102 = -5.56991545570e-6 
a103 = -2.72956962370e-7 
a110 = -7.48716846880e-5 
a111 = -4.73566167220e-7 
a112 =  7.82747741600e-7 
a120 =  7.24244384490e-5 
a121 = -1.03676320965e-5 
a122 =  2.32856664276e-8 
a130 = -3.50383492616e-5 
a131 =  5.18268711320e-6 
a140 = -1.65263794500e-6 
a200 = -4.35926785610e-5 
a201 =  1.11008347650e-5 
a202 =  5.46207488340e-6 
a210 =  7.18156455200e-5 
a211 =  5.85666925900e-6 
a212 = -1.31462208134e-6 
a220 = -4.30608991440e-5 
a221 =  9.49659182340e-7 
a230 =  1.74814722392e-5 
a300 =  3.45324618280e-5 
a301 = -9.84471178440e-6 
a302 = -1.35441856270e-6 
a310 = -3.73971683740e-5 
a311 = -9.76522784000e-7 
a320 =  6.85899736680e-6 
a400 = -1.19594097880e-5 
a401 =  2.59092252600e-6 
a410 =  7.71906784880e-6 
a500 =  1.38645945810e-6 

b000 = -3.10389819760e-4 
b003 =  3.63101885150e-7 
b004 = -1.11471254230e-7 
b010 =  3.50095997640e-5 
b013 = -2.72956962370e-7 
b020 = -3.74358423440e-5 
b030 =  2.41414794830e-5 
b040 = -8.75958731540e-6 
b050 = -3.30527589000e-7 
b100 =  1.33856134076e-3 
b103 =  3.34926075600e-8 
b110 = -8.71853571220e-5 
b120 =  7.18156455200e-5 
b130 = -2.87072660960e-5 
b140 =  8.74073611960e-6 
b200 = -2.55143801811e-3 
b210 =  1.03597385484e-4 
b220 = -5.60957525610e-5 
b230 =  6.85899736680e-6 
b300 =  2.32344279772e-3 
b310 = -4.78376391520e-5 
b320 =  1.54381356976e-5 
b400 = -1.05461852535e-3 
b410 =  6.93229729050e-6 
b500 =  1.91594743830e-4 
b001 =  2.42624687470e-5 
b011 = -9.56770881560e-6 
b021 = -2.36783083610e-7 
b031 = -3.45587736550e-6 
b041 =  1.29567177830e-6 
b101 = -6.95849219480e-5 
b111 =  2.22016695300e-5 
b121 =  5.85666925900e-6 
b131 =  6.33106121560e-7 
b201 =  1.12412331915e-4 
b211 = -2.95341353532e-5 
b221 = -1.46478417600e-6 
b301 = -6.92888744480e-5 
b311 =  1.03636901040e-5 
b401 =  1.54637136265e-5 
b002 = -5.84844329840e-7 
b012 = -5.56991545570e-6 
b022 =  3.91373870800e-7 
b032 =  7.76188880920e-9 
b102 = -9.62445031940e-6 
b112 =  1.09241497668e-5 
b122 = -1.31462208134e-6 
b202 =  1.47789320994e-5 
b212 = -4.06325568810e-6 
b302 = -7.12478989080e-6

c000 = -6.07991438090e-5 
c001 =  1.99712338438e-5 
c002 = -3.39280843110e-6 
c003 =  4.21246123200e-7 
c004 = -6.32363064300e-8 
c005 =  1.17681023580e-8 
c010 =  1.85057654290e-5 
c011 = -2.34727734620e-6 
c012 = -1.09581019659e-6 
c013 =  1.25816399608e-6 
c020 = -1.17166068530e-5 
c021 =  4.26100574800e-6 
c022 =  8.60877154770e-7 
c030 =  7.92796561730e-6 
c031 = -9.22650800740e-7 
c040 = -3.41021874820e-6 
c041 = -1.26705833028e-7 
c050 =  5.07367668140e-7 
c100 =  2.42624687470e-5 
c101 = -1.16968865968e-6 
c102 =  1.08930565545e-6 
c103 = -4.45885016920e-7 
c110 = -9.56770881560e-6 
c111 = -1.11398309114e-5 
c112 = -8.18870887110e-7 
c120 = -2.36783083610e-7 
c121 =  7.82747741600e-7 
c130 = -3.45587736550e-6 
c131 =  1.55237776184e-8 
c140 =  1.29567177830e-6 
c200 = -3.47924609740e-5 
c201 = -9.62445031940e-6 
c202 =  5.02389113400e-8 
c210 =  1.11008347650e-5 
c211 =  1.09241497668e-5 
c220 =  2.92833462950e-6 
c221 = -1.31462208134e-6 
c230 =  3.16553060780e-7 
c300 =  3.74707773050e-5 
c301 =  9.85262139960e-6 
c310 = -9.84471178440e-6 
c311 = -2.70883712540e-6 
c320 = -4.88261392000e-7 
c400 = -1.73222186120e-5 
c401 = -3.56239494540e-6 
c410 =  2.59092252600e-6 
c500 =  3.09274272530e-6 
  
h001 =  1.07699958620e-3
h002 = -3.03995719050e-5
h003 =  3.32853897400e-6
h004 = -2.82734035930e-7
h005 =  2.10623061600e-8
h006 = -2.10787688100e-9
h007 =  2.80192913290e-10
h011 = -1.56497346750e-5
h012 =  9.25288271450e-6
h013 = -3.91212891030e-7
h014 = -9.13175163830e-8
h015 =  6.29081998040e-8
h021 =  2.77621064840e-5
h022 = -5.85830342650e-6
h023 =  7.10167624670e-7
h024 =  7.17397628980e-8
h031 = -1.65211592590e-5
h032 =  3.96398280870e-6
h033 = -1.53775133460e-7
h042 = -1.70510937410e-6
h043 = -2.11176388380e-8
h041 =  6.91113227020e-6
h051 = -8.05396155400e-7
h052 =  2.53683834070e-7
h061 =  2.05430942680e-7
h101 = -3.10389819760e-4
h102 =  1.21312343735e-5
h103 = -1.94948109950e-7
h104 =  9.07754712880e-8
h105 = -2.22942508460e-8
h111 =  3.50095997640e-5
h112 = -4.78385440780e-6
h113 = -1.85663848520e-6
h114 = -6.82392405930e-8
h121 = -3.74358423440e-5
h122 = -1.18391541805e-7
h123 =  1.30457956930e-7
h131 =  2.41414794830e-5
h132 = -1.72793868275e-6
h133 =  2.58729626970e-9
h141 = -8.75958731540e-6
h142 =  6.47835889150e-7
h151 = -3.30527589000e-7
h201 =  6.69280670380e-4
h202 = -1.73962304870e-5
h203 = -1.60407505320e-6
h204 =  4.18657594500e-9
h211 = -4.35926785610e-5
h212 =  5.55041738250e-6
h213 =  1.82069162780e-6
h221 =  3.59078227600e-5
h222 =  1.46416731475e-6
h223 = -2.19103680220e-7
h231 = -1.43536330480e-5
h232 =  1.58276530390e-7
h241 =  4.37036805980e-6
h301 = -8.50479339370e-4
h302 =  1.87353886525e-5
h303 =  1.64210356660e-6
h311 =  3.45324618280e-5
h312 = -4.92235589220e-6
h313 = -4.51472854230e-7
h321 = -1.86985841870e-5
h322 = -2.44130696000e-7
h331 =  2.28633245560e-6
h401 =  5.80860699430e-4
h402 = -8.66110930600e-6
h403 = -5.93732490900e-7
h411 = -1.19594097880e-5
h421 =  3.85953392440e-6
h412 =  1.29546126300e-6
h501 = -2.10923705070e-4
h502 =  1.54637136265e-6
h511 =  1.38645945810e-6
h601 =  3.19324573050e-5

v000 =  1.0769995862e-3 
v001 = -6.0799143809e-5 
v002 =  9.9856169219e-6 
v003 = -1.1309361437e-6 
v004 =  1.0531153080e-7 
v005 = -1.2647261286e-8 
v006 =  1.9613503930e-9 
v010 = -3.1038981976e-4 
v011 =  2.4262468747e-5 
v012 = -5.8484432984e-7 
v013 =  3.6310188515e-7 
v014 = -1.1147125423e-7 
v020 =  6.6928067038e-4 
v021 = -3.4792460974e-5 
v022 = -4.8122251597e-6 
v023 =  1.6746303780e-8 
v030 = -8.5047933937e-4 
v031 =  3.7470777305e-5 
v032 =  4.9263106998e-6 
v040 =  5.8086069943e-4 
v041 = -1.7322218612e-5 
v042 = -1.7811974727e-6 
v050 = -2.1092370507e-4 
v051 =  3.0927427253e-6 
v060 =  3.1932457305e-5 
v100 = -1.5649734675e-5 
v101 =  1.8505765429e-5 
v102 = -1.1736386731e-6 
v103 = -3.6527006553e-7 
v104 =  3.1454099902e-7 
v110 =  3.5009599764e-5 
v111 = -9.5677088156e-6 
v112 = -5.5699154557e-6 
v113 = -2.7295696237e-7 
v120 = -4.3592678561e-5 
v121 =  1.1100834765e-5 
v122 =  5.4620748834e-6 
v130 =  3.4532461828e-5 
v131 = -9.8447117844e-6 
v132 = -1.3544185627e-6 
v140 = -1.1959409788e-5 
v141 =  2.5909225260e-6 
v150 =  1.3864594581e-6
v200 =  2.7762106484e-5 
v201 = -1.1716606853e-5 
v202 =  2.1305028740e-6 
v203 =  2.8695905159e-7 
v210 = -3.7435842344e-5 
v211 = -2.3678308361e-7 
v212 =  3.9137387080e-7 
v220 =  3.5907822760e-5 
v221 =  2.9283346295e-6 
v222 = -6.5731104067e-7 
v230 = -1.8698584187e-5 
v231 = -4.8826139200e-7 
v240 =  3.8595339244e-6 
v300 = -1.6521159259e-5 
v301 =  7.9279656173e-6 
v302 = -4.6132540037e-7 
v310 =  2.4141479483e-5 
v311 = -3.4558773655e-6 
v312 =  7.7618888092e-9 
v320 = -1.4353633048e-5 
v321 =  3.1655306078e-7 
v330 =  2.2863324556e-6
v400 =  6.9111322702e-6 
v401 = -3.4102187482e-6 
v402 = -6.3352916514e-8 
v410 = -8.7595873154e-6 
v411 =  1.2956717783e-6 
v420 =  4.3703680598e-6 
v500 = -8.0539615540e-7 
v501 =  5.0736766814e-7 
v510 = -3.3052758900e-7 
v600 =  2.0543094268e-7

def alpha_beta(sal, ct):
#     zt=sst-10  #potential temperature anomaly
#     zs=sal-35 #abs salinity anomaly
#     zh=0.4804548 # depth at the surface
#     rn_a0=1.6550e-1 # thermal expansion coeff
#     rn_b0=7.6554e-1 # saline  expansion coeff
#     rn_lambda1=5.9520e-2 #cabbeling coeff. in T^2
#     rn_mu1=1.4970e-4 #thermobaric coeff. in T
#     rn_nu=2.4341e-3 #cabbeling coeff. in theta*salt  
#     rau0=1026  #volumic mass of reference     [kg/m3]
#     r1_rau0= 1/rau0
#     rn_lambda2=5.4914e-4 #cabbeling coeff. in S^2
#     rn_mu2=1.1090e-5 #thermobaric coeff. in S
#     zn  = rn_a0 * ( 1. + rn_lambda1*zt + rn_mu1*zh ) + rn_nu*zs
#     alpha=zn * r1_rau0 
#     zn  = rn_b0 * ( 1. - rn_lambda2*zs - rn_mu2*zh ) - rn_nu*zt
#     beta=zn * r1_rau0
#     return alpha, beta

    xs = np.sqrt(gsw_sfac*sal + offset)
    ys = ct*0.025
    v = v000 + xs*(v010 + xs*(v020 + xs*(v030 + xs*(v040 + xs*(v050 + v060*xs))))) + ys*(v100 + xs*(v110 + xs*(v120 + xs*(v130 + xs*(v140 + v150*xs)))) + ys*(v200 + xs*(v210 + xs*(v220 + xs*(v230 + v240*xs))) + ys*(v300 + xs*(v310 + xs*(v320 + v330*xs)) + ys*(v400 + xs*(v410 + v420*xs) + ys*(v500 + v510*xs + v600*ys)))))
    rho = 1.0/v
    v_ct_part = a000 + xs*(a100 + xs*(a200 + xs*(a300 + xs*(a400 + a500*xs))))+ ys*(a010 + xs*(a110 + xs*(a210 + xs*(a310 + a410*xs))) + ys*(a020 + xs*(a120 + xs*(a220 + a320*xs)) + ys*(a030 + xs*(a130 + a230*xs) + ys*(a040 + a140*xs + a050*ys ))))
    alpha = 0.025*v_ct_part/v
    v_sa_part = b000 + xs*(b100 + xs*(b200 + xs*(b300 + xs*(b400 + b500*xs)))) + ys*(b010 + xs*(b110 + xs*(b210 + xs*(b310 + b410*xs))) + ys*(b020 + xs*(b120 + xs*(b220 + b320*xs)) + ys*(b030 + xs*(b130 + b230*xs) + ys*(b040 + b140*xs + b050*ys))))
    beta = -v_sa_part*0.5*gsw_sfac/(v*xs)
    return alpha, beta

def specvol(sal, ct) :
    xs = np.sqrt(gsw_sfac*sal + offset)
    ys = ct*0.025

    gsw_specvol = v000 + xs*(v010 + xs*(v020 + xs*(v030 + xs*(v040 + xs*(v050 + v060*xs))))) + ys*(v100 + xs*(v110 + xs*(v120 + xs*(v130 + xs*(v140 + v150*xs)))) + ys*(v200 + xs*(v210 + xs*(v220 + xs*(v230 + v240*xs))) + ys*(v300 + xs*(v310 + xs*(v320 + v330*xs)) + ys*(v400 + xs*(v410 + v420*xs) + ys*(v500 + v510*xs + v600*ys))))) 
    return gsw_specvol


def specvol_first_derivatives(sal, ct) :
    xs = np.sqrt(gsw_sfac*sal + offset)
    ys = ct*0.025
    
    # derivative with respect to salinity
    v_sa_part = b000 + xs*(b100 + xs*(b200 + xs*(b300 + xs*(b400 + b500*xs)))) + ys*(b010 + xs*(b110 + xs*(b210 + xs*(b310 + b410*xs))) + ys*(b020 + xs*(b120 + xs*(b220 + b320*xs)) + ys*(b030 + xs*(b130 + b230*xs) + ys*(b040 + b140*xs + b050*ys))))
    v_sa = 0.5*gsw_sfac*v_sa_part/xs
    
    # derivative with respect to conservative temperature
    v_ct_part = a000 + xs*(a100 + xs*(a200 + xs*(a300 + xs*(a400 + a500*xs))))+ ys*(a010 + xs*(a110 + xs*(a210 + xs*(a310 + a410*xs))) + ys*(a020 + xs*(a120 + xs*(a220 + a320*xs)) + ys*(a030 + xs*(a130 + a230*xs) + ys*(a040 + a140*xs + a050*ys )))) 
    v_ct = 0.025*v_ct_part
    
    return v_sa, v_ct

def specvol_second_derivatives(sal, ct) :
    xs2 = gsw_sfac*sal + offset
    xs = np.sqrt(xs2)
    ys = ct*0.025

    v_sa_sa_part = (-b000 + xs2*(b200 + xs*(2.0*b300 + xs*(3.0*b400 + 4.0*b500*xs))) + ys*(-b010 + xs2*(b210 + xs*(2.0*b310 + 3.0*b410*xs)) + ys*(-b020 + xs2*(b220 + 2.0*b320*xs) + ys*(-b030 + b230*xs2 + ys*(-b040 - b050*ys)))))/xs2
    v_sa_sa = 0.25*gsw_sfac*gsw_sfac*v_sa_sa_part/xs

    v_sa_ct_part = (b010 + xs*(b110 + xs*(b210 + xs*(b310 + b410*xs))) + ys*(2.0*(b020 + xs*(b120 + xs*(b220 + b320*xs)))+ ys*(3.0*(b030 + xs*(b130 + b230*xs)) + ys*(4.0*(b040 + b140*xs) + 5.0*b050*ys))))/xs
    v_sa_ct = 0.025*0.5*gsw_sfac*v_sa_ct_part

    v_ct_ct_part = a010 + xs*(a110 + xs*(a210 + xs*(a310 + a410*xs))) + ys*(2.0*(a020 + xs*(a120 + xs*(a220 + a320*xs))) + ys*(3.0*(a030 + xs*(a130 + a230*xs)) + ys*(4.0*(a040 + a140*xs) + 5.0*a050*ys)))
    v_ct_ct = 0.025*0.025*v_ct_ct_part
    return v_sa_sa, v_sa_ct, v_ct_ct

def rho_second_derivatives(sal, ct) :
    v_sa,v_ct = specvol_first_derivatives(sal, ct)

    v_sa_sa,v_sa_ct,v_ct_ct = specvol_second_derivatives(sal,ct)

    rec_v = 1.0/specvol(sal,ct)
    rec_v2 = rec_v*rec_v
    rec_v3 = rec_v2*rec_v

    rho_sa_sa = -v_sa_sa*rec_v2 + 2.0*v_sa*v_sa*rec_v3
    rho_sa_ct = -v_sa_ct*rec_v2 + 2.0*v_sa*v_ct*rec_v3
    rho_ct_ct = -v_ct_ct*rec_v2 + 2.0*v_ct*v_ct*rec_v3
    return rho_sa_sa,rho_sa_ct,rho_ct_ct
